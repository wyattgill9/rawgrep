# CI for rawgrep
# Tests/benchmarks TBD

name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    # Catch upstream breakage weekly (nightly changes, dep updates)
    - cron: "0 7 * * 1"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # --------------------------
  # BUILD + CLIPPY
  # --------------------------
  build:
    name: Build (${{ matrix.rust }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release
      - name: Clippy
        run: cargo clippy --all-targets -- -D warnings

  # --------------------------
  # NIGHTLY (with use_nightly feature)
  # --------------------------
  nightly:
    name: Build (nightly + use_nightly)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo build --release --features use_nightly
      - name: Clippy
        run: cargo clippy --all-targets --features use_nightly -- -D warnings

  # --------------------------
  # FEATURE COMBINATIONS
  # --------------------------
  features:
    name: Feature powerset
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - uses: taiki-e/install-action@cargo-hack
      - name: Check feature combinations
        run: |
          cargo hack check --feature-powerset \
            --at-least-one-of=small,full \
            --mutually-exclusive-features=small,full \
            --mutually-exclusive-features=mimalloc,dhat \
            --depth=3

  # --------------------------
  # SECURITY & DEPENDENCY CHECKS
  # --------------------------
  security:
    name: Security audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deps:
    name: Dependency check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check bans licenses sources
